= BLS Wage Data Getter
:toc:

A TypeScript application for fetching and storing wage data from the U.S. Bureau of Labor Statistics (BLS) Occupational Employment and Wage Statistics (OEWS) API.

== Overview

This project crawls BLS wage data by SOC (Standard Occupational Classification) and NAICS (North American Industry Classification System) codes, storing the results in a PostgreSQL database for analysis and reporting.

== Features

* Fetches SOC codes from BLS API
* Retrieves NAICS codes with hierarchical structure
* Crawls wage data for SOC/NAICS combinations
* Stores data in PostgreSQL with proper schema
* Type-safe validation using TypeBox schemas
* Automated database migrations with Kysely

== Project Structure

[source,text]
----
src/
├── db/
│   ├── generated/           # Kysely-generated types
│   ├── migrations/          # Database schema migrations
│   ├── index.ts             # Database connection setup
│   └── migrate.ts           # Migration runner
├── schemas/
│   ├── schemas.ts           # TypeBox schemas
│   ├── validate.ts          # Response validation
│   └── validation.test.ts   # Schema tests
└── scripts/
    ├── apply_migrations.ts  # Run migrations via script
    ├── constants.ts         # Shared script constants
    ├── test_db_connection.ts
    ├── get_socs/
    │   ├── run.ts            # Fetch SOC codes
    │   └── utils.ts
    ├── get_naics/
    │   ├── run.ts            # Fetch NAICS codes
    │   └── utils.ts
    └── crawl_wages/
        ├── run.ts            # Crawl wage data
        └── utils.ts
└── test-utils/
    ├── testDBManager.ts       # Test database lifecycle helpers
    └── testDataSeeder/
        ├── constants.ts       # Seeder defaults
        ├── index.ts            # Seed orchestration
        └── deterministicRandom/
            ├── dRandom.ts      # Deterministic RNG
            ├── hashing.ts      # Stable hashing helpers
            └── overridableFieldHelpers.ts # Repeatable overrides
----

== Database Schema

* `soc_codes` - Standard Occupational Classification codes
* `naics_codes` - NAICS codes with hierarchical levels
* `oews_series` - BLS series metadata
* `wages` - Annual wage data by series and year

== Prerequisites

* Node.js (see `.nvmrc` for the recommended version)
** Node.js version should include TypeScript type stripping support (scripts execute .ts files directly via node; use a Node version that supports this or set NODE_OPTIONS=--experimental-strip-types)
* Docker & Docker Compose
* BLS API key (register at https://data.bls.gov/registrationEngine/)

== Setup

. Clone the repository
. Install dependencies:
+
[source,bash]
----
npm install
----
+
. Copy environment variables:
+
[source,bash]
----
cp .env.example .env
----
+
. Edit `.env` and add your BLS API key:
+
[source]
----
BLS_API_KEY=your_api_key_here
----
+


== Usage

. Start the database:
+
[source,bash]
----
npm run db:setup
----
+
This command:
+ 
* Starts PostgreSQL container
* Runs database migrations
* Generates TypeScript types
+
. Test database connection:
+
[source,bash]
----
npm run db:test:conn
----
+
. Fetch SOC codes (if you haven't done so recently):
+
[source,bash]
----
npm run get:socs
----
+
. Fetch NAICS codes (if you haven't done so recently):
+
[source,bash]
----
npm run get:naics
----
+
. Crawl wage data (this should resume where you left off if you didn't complete your crawl last time):
+
[source,bash]
----
npm run crawl
----
+
. Explore the data with something like https://www.beekeeperstudio.io/[Beekeeper] or https://www.pgadmin.org/[pgAdmin]. You can use the config in `.env.example` to connect to the local database.
. Spin down the database when you're finished
+
[source,bash]
----
npm run db:down
----


== Development

* Format code:
+
[source,bash]
----
npm run format
----
+
* Run tests:
+
[source,bash]
----
npm run test
----
+
NOTE: Use `npm run test` (not `npx vitest`) so env-cmd loads `.env.test`; Vitest expects env vars to be preloaded by the script.

* Run tests with coverage:
+
[source,bash]
----
npm run test:coverage
----


== Database Management

Start database:

[source,bash]
----
npm run db:up
----

Stop database:

[source,bash]
----
npm run db:down
----

View database logs:

[source,bash]
----
npm run db:logs
----

Run migrations:

[source,bash]
----
npm run db:migrate
----

Generate TypeScript types:

[source,bash]
----
npm run db:codegen
----

== Environment Variables

* `BLS_API_KEY` - BLS API key (required)
* `DATABASE_URL` - PostgreSQL connection URL (defaults to local Docker container)
* Tests load `.env.test` via env-cmd in the npm script; running Vitest directly will skip this

== Technologies

* **Runtime**: Node.js
* **Database**: PostgreSQL with Kysely ORM
* **Validation**: TypeBox schemas
* **Testing**: Vitest
* **Formatting**: Prettier
* **Git Hooks**: Husky

== License

MIT
