= BLS Wage Data Getter
:toc:

A TypeScript application for downloading and storing wage data from the U.S. Bureau of Labor Statistics (BLS) Occupational Employment and Wage Statistics (OEWS) bulk files.

== Overview

This project loads BLS OEWS data by SOC (Standard Occupational Classification) and NAICS (North American Industry Classification System) codes from the bulk time series files, storing the results in a PostgreSQL database for analysis and reporting.

== Features

* Downloads OEWS bulk files and caches them locally
* Parses OEWS mapping files for SOCs, industries, areas, and datatypes
* Loads OEWS series metadata and data values into PostgreSQL
* Stores data in PostgreSQL with proper schema
* Type-safe validation using TypeBox schemas
* Automated database migrations with Kysely

== Project Structure

[source,text]
----
src/
├── db/
│   ├── generated/           # Kysely-generated types
│   ├── migrations/          # Database schema migrations
│   ├── index.ts             # Database connection setup
│   └── migrate.ts           # Migration runner
├── schemas/
│   ├── schemas.ts           # TypeBox schemas
│   ├── validate.ts          # Response validation
│   └── validation.test.ts   # Schema tests
└── scripts/
    ├── apply_migrations.ts  # Run migrations via script
    ├── constants.ts         # Shared script constants
    ├── test_db_connection.ts
    ├── bulk/
    │   ├── download.ts       # Download OEWS bulk files
    │   ├── ingest_mappings.ts # Load mapping tables
    │   ├── ingest_series.ts   # Load OEWS series metadata
    │   ├── ingest_data.ts     # Load OEWS data values
    │   └── run.ts             # Download + ingest end-to-end
    ├── get_socs/
    │   ├── run.ts            # Fetch SOC codes
    │   └── utils.ts
    ├── get_naics/
    │   ├── run.ts            # Fetch NAICS codes
    │   └── utils.ts
└── test-utils/
    ├── testDBManager.ts       # Test database lifecycle helpers
    └── testDataSeeder/
        ├── constants.ts       # Seeder defaults
        ├── index.ts            # Seed orchestration
        └── deterministicRandom/
            ├── dRandom.ts      # Deterministic RNG
            ├── hashing.ts      # Stable hashing helpers
            └── overridableFieldHelpers.ts # Repeatable overrides
----

== Database Schema

* `soc_codes` - Standard Occupational Classification codes (normalized)
* `naics_codes` - NAICS codes with hierarchical levels (normalized)
* `oe_occupations` - OEWS occupation mapping file
* `oe_industries` - OEWS industry mapping file
* `oe_areas` - OEWS area mapping file
* `oe_areatypes` - OEWS area types
* `oe_datatypes` - OEWS data type definitions
* `oe_footnotes` - OEWS footnote definitions
* `oe_releases` - OEWS release metadata
* `oe_seasonal` - OEWS seasonality definitions
* `oe_sectors` - OEWS sector definitions
* `oe_series` - OEWS series metadata (bulk file)
* `oe_data` - OEWS data values (bulk file)

== Prerequisites

* Node.js (see `.nvmrc` for the recommended version)
** Node.js version should include TypeScript type stripping support (scripts execute .ts files directly via node; use a Node version that supports this or set NODE_OPTIONS=--experimental-strip-types)
* Docker & Docker Compose

== Setup

. Clone the repository
. Install dependencies:
+
[source,bash]
----
npm install
----
+
. Copy environment variables:
+
[source,bash]
----
cp .env.example .env
----
+


== Usage

. Start the database:
+
[source,bash]
----
npm run db:setup
----
+
This command:
+ 
* Starts PostgreSQL container
* Runs database migrations
* Generates TypeScript types
+
. Test database connection:
+
[source,bash]
----
npm run db:test:conn
----
+
. Download and ingest OEWS bulk files:
+
[source,bash]
----
npm run bulk:ingest
----
+
. This will download the latest OEWS files and load mappings, series metadata, and data values into the database.
+
. Use the mapping tables to interpret codes in `oe_series` and `oe_data`:
+
[source,sql]
----
select
  s.series_id,
  o.occupation_name,
  i.industry_name,
  d.datatype_name,
  a.area_name,
  s.series_title,
  s.begin_year,
  s.end_year
from oe_series s
join oe_occupations o on o.occupation_code = s.occupation_code
join oe_industries i on i.industry_code = s.industry_code
join oe_datatypes d on d.datatype_code = s.datatype_code
join oe_areas a on a.area_code = s.area_code and a.state_code = s.state_code
limit 25;
----
+
. The bulk ingest also populates normalized SOC and NAICS tables. You can refresh those tables independently:
+
[source,bash]
----
npm run get:socs
npm run get:naics
----
+
. Explore the data with something like https://www.beekeeperstudio.io/[Beekeeper] or https://www.pgadmin.org/[pgAdmin]. You can use the config in `.env.example` to connect to the local database.
. Spin down the database when you're finished
+
[source,bash]
----
npm run db:down
----


== Development

* Format code:
+
[source,bash]
----
npm run format
----
+
* Run tests:
+
[source,bash]
----
npm run test
----
+
NOTE: Use `npm run test` (not `npx vitest`) so env-cmd loads `.env.test`; Vitest expects env vars to be preloaded by the script.

* Run tests with coverage:
+
[source,bash]
----
npm run test:coverage
----


== Database Management

Start database:

[source,bash]
----
npm run db:up
----

Stop database:

[source,bash]
----
npm run db:down
----

View database logs:

[source,bash]
----
npm run db:logs
----

Run migrations:

[source,bash]
----
npm run db:migrate
----

Generate TypeScript types:

[source,bash]
----
npm run db:codegen
----

== Environment Variables

* `DATABASE_URL` - PostgreSQL connection URL (defaults to local Docker container)
* Tests load `.env.test` via env-cmd in the npm script; running Vitest directly will skip this

== Technologies

* **Runtime**: Node.js
* **Database**: PostgreSQL with Kysely ORM
* **Validation**: TypeBox schemas
* **Testing**: Vitest
* **Formatting**: Prettier
* **Git Hooks**: Husky

== License

MIT
